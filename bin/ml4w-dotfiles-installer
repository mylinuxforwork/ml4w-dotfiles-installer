#!/usr/bin/env bash

# 1. Determine the Library Path
if [ -d "$(dirname "$0")/../lib" ]; then
    LIB_DIR="$(cd "$(dirname "$0")/../lib" && pwd)"
else
    LIB_DIR="$HOME/.local/share/ml4w-dotfiles-installer"
fi

# 2. Source Modules
source "$LIB_DIR/colors.sh"
source "$LIB_DIR/helpers.sh"
source "$LIB_DIR/utils.sh"

# Default settings
DOTFILES_DIR="$HOME/.mydotfiles"
TEST_MODE=false

# --- Check for Installer Config Folder ---
INSTALLER_CONFIG="$HOME/.config/ml4w-dotfiles-installer"
if [ ! -d "$INSTALLER_CONFIG" ]; then
    mkdir -p "$INSTALLER_CONFIG"
fi

# 3. Global Cleanup Trap
cleanup() {
    if [ -n "$CLONE_PATH" ] && [ -d "$CLONE_PATH" ]; then
        info "Cleaning up temporary files..."
        rm -rf "$CLONE_PATH"
    fi
}
trap cleanup EXIT

# 4. Help Function
show_help() {
    echo "Usage: ml4w-dotfiles-installer [OPTIONS]"
    echo ""
    echo "Options: "
    echo "  --install <path/url> Install dotfiles from local path or URL"
    echo "  --target <path>      Target directory (Default: $HOME/.mydotfiles-test)"
    echo "  --testmode           Run setup logic only (No staging, No symlinks)"
    echo "  --help               Show this help message"
}

# 5. Argument Parsing
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --install)
            INSTALL_URL="$2"
            if [[ ! "$INSTALL_URL" =~ ^https?:// ]] && [ -f "$INSTALL_URL" ]; then
                INSTALL_URL=$(realpath "$INSTALL_URL")
            fi
            shift 2 ;;
        --target)
            DOTFILES_DIR="$(mkdir -p "$2" && cd "$2" && pwd)"
            shift 2 ;;
        --testmode)
            TEST_MODE=true
            shift ;;
        --help)
            show_help
            exit 0 ;;
        *)
            error "Unknown option: $1"
            show_help
            exit 1 ;;
    esac
done

# 6. Execute Logic
[ -z "$INSTALL_URL" ] && { show_help; exit 0; }

check_dependencies

# Step B: Read configuration and prepare environment
RESULT=$(read_dotinst "$INSTALL_URL" "$DOTFILES_DIR" "$TEST_MODE")

# Catch cases where the subshell exited early or cancelled
[ -z "$RESULT" ] && exit 0

CLONE_PATH=$(echo "$RESULT" | awk '{print $1}')
PROFILE_ID=$(echo "$RESULT" | awk '{print $2}')
SUBFOLDER=$(echo "$RESULT" | awk '{print $3}')

if [ -n "$CLONE_PATH" ] && [ -d "$CLONE_PATH" ]; then
    PROFILE_CONFIG="$INSTALLER_CONFIG/$PROFILE_ID"
    mkdir -p "$PROFILE_CONFIG"

    FINAL_TARGET="$DOTFILES_DIR/$PROFILE_ID"

    # --- Step B.5: Update-specific Logic (Backup & Restore) ---
    if [ -d "$FINAL_TARGET" ] && [ "$TEST_MODE" = false ]; then
        backup_existing_profile "$FINAL_TARGET" "$PROFILE_ID" "$DOTFILES_DIR"

        DOTINST_JSON=$(get_json_content "$INSTALL_URL")
        RESTORE_COUNT=$(echo "$DOTINST_JSON" | jq '.restore | length' 2>/dev/null)
        
        if [ "$RESTORE_COUNT" != "null" ] && [ "$RESTORE_COUNT" -gt 0 ]; then
            handle_restore_logic "$DOTINST_JSON" "$FINAL_TARGET" "$CLONE_PATH" "$SUBFOLDER"
        fi
    fi

    info "Repository prepared. Starting package setup..."
    run_setup_logic "$CLONE_PATH" "$PROFILE_ID"
    
    # --- Step C: Test Mode Exit ---
    if [ "$TEST_MODE" = true ]; then
        warn "Test Mode active: Skipping file staging and symlink creation."
        info "Setup logic completed successfully."
        exit 0
    fi

    # Step D: Deploy staged dotfiles
    BLACKLIST_FILE="$PROFILE_CONFIG/blacklist"

    if [ -n "$SUBFOLDER" ] && [ "$SUBFOLDER" != "null" ]; then
        SRC_DIR="$CLONE_PATH/$SUBFOLDER"
    else
        SRC_DIR="$CLONE_PATH"
    fi

    if [ -d "$SRC_DIR" ]; then
        if copy_with_blacklist "$SRC_DIR" "$FINAL_TARGET" "$BLACKLIST_FILE"; then
            info "Successfully updated $PROFILE_ID dotfiles in sandbox."
            
            # Step E: Create symlinks
            deploy_symlinks "$FINAL_TARGET" "$DOTFILES_DIR" "$PROFILE_ID"
            
            info "Installation successful! Please reboot your system."
        else
            error "Failed to deploy dotfiles."
            exit 1
        fi
    else
        error "Source folder '$SRC_DIR' not found in cloned repository."
        exit 1
    fi
else
    error "Installation failed: Repository environment could not be initialized."
    exit 1
fi
