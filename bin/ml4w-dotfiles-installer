#!/usr/bin/env bash

# 1. Determine the Library Path
if [ -d "$(dirname "$0")/../lib" ]; then
    LIB_DIR="$(cd "$(dirname "$0")/../lib" && pwd)"
else
    LIB_DIR="$HOME/.local/share/ml4w-dotfiles-installer"
fi

# 2. Source Modules
source "$LIB_DIR/colors.sh"
source "$LIB_DIR/utils.sh"

# Default Target Directory
DOTFILES_DIR="$HOME/.mydotfiles-test"

# --- Check for Installer Config Folder ---
INSTALLER_CONFIG="$HOME/.config/ml4w-dotfiles-installer"
if [ ! -d "$INSTALLER_CONFIG" ]; then
    mkdir -p "$INSTALLER_CONFIG"
fi

# 3. Global Cleanup Trap
cleanup() {
    if [ -n "$CLONE_PATH" ] && [ -d "$CLONE_PATH" ]; then
        info "Cleaning up temporary files..."
        rm -rf "$CLONE_PATH"
    fi
}
trap cleanup EXIT

# 4. Help Function
show_help() {
    echo "Usage: ml4w-dotfiles-installer [OPTIONS]"
    echo ""
    echo "Options: "
    echo "  --install <url>     Install dotfiles from a .dotinst URL"
    echo "  --target <path>     Target directory (Default: $HOME/.mydotfiles-test)"
    echo "  --help              Show this help message"
}

# 5. Argument Parsing
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --install)
            INSTALL_URL="$2"
            shift 2 ;;
        --target)
            DOTFILES_DIR="$(mkdir -p "$2" && cd "$2" && pwd)"
            shift 2 ;;
        --help)
            show_help
            exit 0 ;;
        *)
            error "Unknown option: $1"
            show_help
            exit 1 ;;
    esac
done

# 6. Execute Logic
[ -z "$INSTALL_URL" ] && { show_help; exit 0; }

check_dependencies

# Step B: Read configuration and clone repo
RESULT=$(read_dotinst "$INSTALL_URL" "$DOTFILES_DIR")
CLONE_PATH=$(echo "$RESULT" | awk '{print $1}')
PROFILE_ID=$(echo "$RESULT" | awk '{print $2}')

if [ -n "$CLONE_PATH" ] && [ -d "$CLONE_PATH" ]; then
    # Create/Get subfolder for Dotfiles ID
    PROFILE_CONFIG="$INSTALLER_CONFIG/$PROFILE_ID"
    mkdir -p "$PROFILE_CONFIG"

    FINAL_TARGET="$DOTFILES_DIR/$PROFILE_ID"

    # --- Step B.5: Restore Logic (ONLY for Updates) ---
    if [ -d "$FINAL_TARGET" ]; then
        DOTINST_JSON=$(curl -sL "$INSTALL_URL")
        
        # Check if the restore section exists and is not empty
        RESTORE_COUNT=$(echo "$DOTINST_JSON" | jq '.restore | length' 2>/dev/null)
        
        if [ "$RESTORE_COUNT" != "null" ] && [ "$RESTORE_COUNT" -gt 0 ]; then
            handle_restore_logic "$DOTINST_JSON" "$FINAL_TARGET" "$CLONE_PATH"
        fi
    fi

    info "Repository prepared. Starting package setup..."
    
    # Step C: Run dependency logic
    run_setup_logic "$CLONE_PATH"
    
    # Step D: Deploy dotfiles with recursive blacklist check
    BLACKLIST_FILE="$PROFILE_CONFIG/blacklist"

    if [ -d "$CLONE_PATH/dotfiles" ]; then
        if copy_with_blacklist "$CLONE_PATH/dotfiles" "$FINAL_TARGET" "$BLACKLIST_FILE"; then
            info "Successfully updated $PROFILE_ID dotfiles."
            
            # Step E: Create symlinks from the local copy to $HOME
            deploy_symlinks "$FINAL_TARGET" "$DOTFILES_DIR"
            
            info "Installation successful!"
        else
            error "Failed to deploy dotfiles."
            exit 1
        fi
    else
        error "Source folder 'dotfiles' not found in cloned repository."
        exit 1
    fi
else
    error "Installation failed: Repository environment could not be initialized."
    exit 1
fi