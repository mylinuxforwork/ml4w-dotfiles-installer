#!/usr/bin/env bash

# 1. Determine the Library Path
if [ -d "$(dirname "$0")/../lib" ]; then
    LIB_DIR="$(cd "$(dirname "$0")/../lib" && pwd)"
else
    LIB_DIR="$HOME/.local/share/ml4w-dotfiles-installer"
fi

# 2. Source Modules
source "$LIB_DIR/colors.sh"
source "$LIB_DIR/utils.sh"

# 3. Global Cleanup Trap
cleanup() {
    if [ -n "$CLONE_PATH" ] && [ -d "$CLONE_PATH" ]; then
        info "Cleaning up temporary files..."
        rm -rf "$CLONE_PATH"
    fi
}
trap cleanup EXIT

# 4. Help Function
show_help() {
    echo "Usage: ml4w-dotfiles-installer [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --install <url>    Install dotfiles from a .dotinst URL"
    echo "  --help             Show this help message"
}

# 5. Argument Parsing
while [[ $# -gt 0 ]]; do
    case $1 in
        --install) INSTALL_URL="$2"; shift 2 ;;
        --help) show_help; exit 0 ;;
        *) error "Unknown option: $1"; exit 1 ;;
    esac
done

# 6. Execute Logic
[ -z "$INSTALL_URL" ] && { show_help; exit 0; }

# Step A: Ensure core tools are present
check_dependencies

# Step B: Fetch .dotinst and Clone repo
RESULT=$(read_dotinst "$INSTALL_URL")
CLONE_PATH=$(echo "$RESULT" | cut -d' ' -f1)
INSTALL_EXEC=$(echo "$RESULT" | cut -d' ' -f2)

if [ -d "$CLONE_PATH" ]; then
    info "Repository prepared at: $CLONE_PATH"
    
    # Step C: Run the complex dependency logic (Preflight + Packages)
    run_setup_logic "$CLONE_PATH"
    
    info "Dependency installation completed."
    
    # Step D: Final Execution of the Dotfiles Install Script
    if [ -f "$CLONE_PATH/$INSTALL_EXEC" ]; then
        info "Starting main installation: $INSTALL_EXEC"
        cd "$CLONE_PATH" && bash "$INSTALL_EXEC"
    else
        warn "Main install script $INSTALL_EXEC not found in repo."
    fi
else
    error "Installation failed: Could not prepare temporary repository."
    exit 1
fi